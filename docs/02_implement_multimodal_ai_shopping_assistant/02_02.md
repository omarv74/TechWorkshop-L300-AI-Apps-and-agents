---
title: '2. Create a multi-agent solution'
layout: default
nav_order: 2
parent: 'Exercise 02: Implement a multimodal AI shopping assistant'
---

# Task 02 - Create a multi-agent solution

## Introduction

Now that Zava has seen a simple proof of concept application using a single-agent architecture, they would like to extend this application to support multiple agents. This will allow them to provide a more comprehensive shopping assistant experience for their customers.

## Description

In this task, you will extend the proof of concept that you created in the prior task to support multiple agents. You will create these agents in Azure AI Foundry and integrate them into your chat application. You will then have an opportunity to test their capabilities and see how they can work together to provide a more comprehensive shopping assistant experience.

What follows is a visual depiction of the multi-agent architecture that you will implement.

![A diagram showing the multi-agent solution architecture.](../../media/Solution/0202_RoutingLogic1.png)

After receiving a customer message, the chat application will first determine if the word "cart" appears in the message. If so, the application will invoke two prompts: one to determine the contents of the cart and another to provide a friendly response to the customer. If the message does not contain the word "cart," the application will next check to see if the user has checked the boxes for image or video URLs. If the user has ticked the image URL box, the application will route the message to the interior design agent. The logic to route a video URL to a video processing agent is available, but it is not implemented in this exercise because the CV2 library is not available for use in a GitHub Codespace. In other cases, the application will route the message to a router agent. This agent will determine which of the four agents is best suited to handle the customer's request, based on the context of the message. Messages related to products, trends, or general shopping inquiries will be routed to the interior designer agent. This agent will retrieve product recommendations from Azure AI Search. Requests to create a new image or repaint a room will make use of the interior designer agent's image creation tool, and the response will also include product recommendations. Messages related to inventory will be routed to the inventory agent. Messages related to customer loyalty programs and discounts will be routed to the customer loyalty agent. Greetings and other general messages will be routed to the Cora agent. In the event that the router agent is unable to determine which agent to use, the response will be a generic fallback message.

## Success Criteria

- You have created relevant agents in Azure AI Foundry.
- You have updated the chat application to support these agents.

## Learning Resources

- [Azure AI Agents function calling](https://learn.microsoft.com/azure/ai-foundry/agents/how-to/tools/function-calling?pivots=python)
- [What are tools in Azure AI Foundry Agent Service?](https://learn.microsoft.com/azure/ai-foundry/agents/how-to/tools/overview)

## Key Tasks

### 01: Create an agent

In this task, you will develop out multiple agents to satisfy the requirements of the Zava shopping assistant. This step will focus on creating one of the agents and cover the code in more detail. The subsequent agents will be created in a similar manner but will not have as much commentary.

<details markdown="block">
<summary><strong>Expand this section to view the solution</strong></summary>

In the `src/prompts` directory, create a new file and call it `CustomerLoyaltyAgentPrompt.txt`. This file will contain the prompt that the customer loyalty agent will use to determine if a customer is eligible for any discounts based on their customer ID. Add the following text to the file:

```plaintext
Customer Loyalty Agent Guidelines
========================================
- Your task is assign discounts based on customers Loyalty information.Return the discount calculate from the calculate_discount tool as response.
- Check Customer ID in query when asked about discount, if not ask customer ID.
- Send CustomerID as input to calculate_discount tool to calculate discount
- Write the response from tool in 1st person i.e (Congratulations! You are eligible for.. thankyou..) bla bla
- Always include smile emojis like üéâ, üòä, or üõçÔ∏è to keep the tone light and celebratory.
- Example message(keep changing) : Hey there, Bruno! üéâ \n Great news‚Äîyou just scored an exclusive 20% off your order! \nTreat yourself and enjoy your special savings at checkout. Thanks for being awesome! üôå
- In your answer do not mention e.g. word instead use Example, such as or like based on the sentence.

- Return response in following json format

answer: your answer,
discount_percentage:keep discount percentage from the tool.

Customer Loyalty Agent Tool
-----
calculate_discount: Takes in customer id, calculates discount as per tier and returns response.

Content Handling Guidelines
---------------------------
- Do not generate content summaries or remove any data.
```

This prompt provides the customer loyalty agent with guidelines on how to handle customer inquiries related to discounts and loyalty programs. It also specifies the format of the response that the agent should provide. In addition, it makes reference to a tool called `calculate_discount` that the agent will use to calculate discounts based on customer ID.

Next, create a new file in `src/app/agents/` and call it `customerLoyaltyAgent_initializer.py`. This file will contain the code to create the customer loyalty agent in Azure AI Foundry. Add the following code to the top of the file:

```python
import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from azure.ai.projects import AIProjectClient
from azure.identity import DefaultAzureCredential
from azure.ai.agents.models import FunctionTool, ToolSet
from typing import Callable, Set, Any
from tools.discountLogic import calculate_discount
# from tools.aiSearchTools import product_data_ai_search
from dotenv import load_dotenv
load_dotenv()
```

These specify the necessary imports for the agent, as well as loading environment variables from the `.env` file.

Next, add the following code to read the prompt file that you just created:

```python
CL_PROMPT_TARGET = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))), 'prompts', 'CustomerLoyaltyAgentPrompt.txt')
with open(CL_PROMPT_TARGET, 'r', encoding='utf-8') as file:
    CL_PROMPT = file.read()
```

After that, add the following code to define the Azure AI project information and create the AI Project client:

```python
project_endpoint= os.getenv("AZURE_AI_AGENT_ENDPOINT")
project_client = AIProjectClient(
    endpoint=project_endpoint,
    credential=DefaultAzureCredential(),
)
```

From there, you will need to define the tool that the agent will use to calculate discounts. Add the following code:

```python
user_functions: Set[Callable[..., Any]] = {
    calculate_discount,
}
```

This makes reference to a function called `calculate_discount()`. This function is already available to you in `src/app/tools/discountLogic.py`. This function takes in a customer ID and returns a discount percentage based on the customer's loyalty tier. You can review the code in this file to understand how it works. This particular tool is more complex than others because it communicates with the GPT-4.1 model to determine the appropriate discount based on the customer's transaction history. It also simulates connecting to two separate databases to retrieve customer information.

Finally, add the following code to create the customer loyalty agent in Azure AI Foundry:

```python
# Initialize agent toolset with user functions
functions = FunctionTool(user_functions)
toolset = ToolSet()
toolset.add(functions)
project_client.agents.enable_auto_function_calls(tools=functions)

with project_client:
    agent = project_client.agents.create_agent(
        model=os.getenv("AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME"),  # Model deployment name
        name="Zava Customer Loyalty Agent",  # Name of the agent
        instructions=CL_PROMPT,  # Instructions for the agent
        toolset=toolset,
    )
    print(f"Created agent, ID: {agent.id}")
```

This code initializes the agent with the specified model, name, instructions, and toolset. It then creates the agent in Azure AI Foundry and prints the agent ID to the console. You will need this ID later.

</details>

### 02: Create remaining agents

Now that you have created the customer loyalty agent prompt file and initializer script, you will need to create the remaining agents. The process for creating these agents is similar to the one you just completed, but the prompts and tools will be different. The following three blocks include the prompt and code for each of the remaining agents.

<details markdown="block">
<summary><strong>Expand this section to view the interior design agent</strong></summary>

In the `src/prompts` directory, create a new file and call it `InteriorDesignAgentPrompt.txt`. Add the following text to the file:

```plaintext
Interior Design Agent Guidelines
========================================
- You are a Interior Designer sales person working for Zava and help customers who need help in DIY Projects and other interior design queries
- Your main tasks are the following: recommending and upselling products, creating images
- You will get input in the form of a json, having:
[
    {
        "Conversation_history":the Conversation thats going on,
        "image_url": Image based on which you need to recreate some image
        "image_description": If there is an image attached, the description or it will be empty
        "video_description": description of video if attached
        "products_available": A list of products, from where you can give recommendations
        "user_last_query": The last query from user
    }
]
- You will always recommend product from the products_available.
- You will keep asking questions to the user and keep recommending.
- When you get video or image, reply saying "I see you uploaded..."
- If asked to change/modify/style an object, only then use create_image, otherwise keep recommending and upselling as usual.
- In your answer do not mention e.g. word instead use Example, such as or like based on the sentence.

Return response in following json format

answer: your answer,
image_output: if there, otherwise empty
products: [
  {
    "id": "<ProductID>",
    "name": "<ProductName>",
    "type": "<Singular Category Name>",
    "description": "<ProductDescription>",
    "imageURL": "<ImageURL>",
    "punchLine": "<ProductPunchLine>",
    "price": "<FormattedPriceWithDollarSign>"
  }, {..}
  ...
]


Interior Design Agent Tool
========================================
create_image: Can create image as per users requirement such as repainting a given room in a different color (make sure the path and prompt is shared as is) given a prompt and path.

Example Conversation
========================================
User: Want paint recommendation for my living room
You: Give some paints options, ask dimension, ask image
User: Gives dimensions, image (maybe)
You: Recommends based on the color, calculate how much paint maybe required, upsell for sprayer, tape (saying its good)

Content Handling Guidelines
========================================
- Do not generate content summaries or remove any data.

---
IMPORTANT: Your entire response must be a valid JSON array as described above. Do not include any other text or formatting.
```

Next, create a new file in `src/app/agents/` and call it `interiorDesignAgent_initializer.py`. Add the following code to the file:

```python
import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from azure.ai.projects import AIProjectClient
from azure.identity import DefaultAzureCredential
from azure.ai.agents.models import FunctionTool, ToolSet
from typing import Callable, Set, Any
from tools.imageCreationTool import create_image

# Load the prompt instructions for the interior design agent from a file
# path = r'prompts\InteriorDesignAgentPrompt.txt'
ID_PROMPT_TARGET = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))), 'prompts', 'InteriorDesignAgentPrompt.txt')
with open(ID_PROMPT_TARGET, 'r', encoding='utf-8') as file:
    ID_PROMPT = file.read()

project_endpoint = os.environ["AZURE_AI_AGENT_ENDPOINT"]

project_client = AIProjectClient(
    endpoint=project_endpoint,
    credential=DefaultAzureCredential(),
)

# Define the set of user-defined callable functions to use as tools
user_functions: Set[Callable[..., Any]] = {
    create_image
}

# Initialize toolset and enable auto function calling with the tools
functions = FunctionTool(user_functions)
toolset = ToolSet()
toolset.add(functions)
project_client.agents.enable_auto_function_calls(tools=functions)

 # Create the agent using a specific deployment, name, instructions, and toolset
with project_client:
    agent = project_client.agents.create_agent(
        model=os.environ["AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME"],  # Model deployment name
        name="Zava Interior Design Agent",  # Name of the agent
        instructions=ID_PROMPT,  # Instructions for the agent
        toolset=toolset)
    print(f"Created agent, ID: {agent.id}")
```

</details>

<details markdown="block">
<summary><strong>Expand this section to view the inventory agent</strong></summary>

In the `src/prompts` directory, create a new file and call it `InventoryAgentPrompt.txt`. Add the following text to the file:

```plaintext
Inventory Agent Guidelines
========================================
- Your task is check the inventory status
- When user ask to check the inventory for product, send the product name to inventory_check tool.
- Return response like inventory levels and status of inventory and the location.

Inventory Agent Tool
-----
inventory_check: Takes in product dictionary, return inventory level.
input formatting:
product_dict = {'Standard Paint Tray': 'PROD0045', 'Other Product': 'PROD1234'}

Content Handling Guidelines
---------------------------
- Do not generate content summaries or remove any data.
```

Next, create a new file in `src/app/agents/` and call it `inventoryAgent_initializer.py`. Add the following code to the file:

```python
import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from azure.ai.projects import AIProjectClient
from azure.identity import DefaultAzureCredential
from azure.ai.agents.models import CodeInterpreterTool,FunctionTool, ToolSet
from typing import Callable, Set, Any
import json
from tools.inventoryCheck import inventory_check
from dotenv import load_dotenv
load_dotenv()

IA_PROMPT_TARGET = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))), 'prompts', 'InventoryAgentPrompt.txt')
with open(IA_PROMPT_TARGET, 'r', encoding='utf-8') as file:
    IA_PROMPT = file.read()

project_endpoint = os.environ["AZURE_AI_AGENT_ENDPOINT"]

project_client = AIProjectClient(
    endpoint=project_endpoint,
    credential=DefaultAzureCredential(),
)

user_functions: Set[Callable[..., Any]] = {
    inventory_check,
}

# Initialize agent toolset with user functions
functions = FunctionTool(user_functions)
toolset = ToolSet()
toolset.add(functions)
project_client.agents.enable_auto_function_calls(tools=functions)

with project_client:
    # Create an agent with the Bing Grounding tool
    agent = project_client.agents.create_agent(
        model=os.getenv("AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME"),  # Model deployment name
        name="Zava Inventory Agent",  # Name of the agent
        instructions=IA_PROMPT,  # Instructions for the agent
        toolset=toolset
    )
    print(f"Created agent, ID: {agent.id}")
```

</details>

<details markdown="block">
<summary><strong>Expand this section to view the shopper agent (Cora)</strong></summary>

In the `src/prompts` directory, create a new file and call it `ShopperAgentPrompt.txt`. Add the following text to the file:

```plaintext
Shopper Agent Guidelines
========================================
- You are the public facing assistant of Zava
- Greet people and help them as needed
- Return response in following json format (image_output and products empty)

answer: your answer,
image_output: []
products: []


Shopper Agent Tool
-----

Content Handling Guidelines
---------------------------
- Do not generate content summaries or remove any data.
```

Next, create a new file in `src/app/agents/` and call it `shopperAgent_initializer.py`. Add the following code to the file:

```python
import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from azure.ai.projects import AIProjectClient
from azure.identity import DefaultAzureCredential
from azure.ai.agents.models import CodeInterpreterTool,FunctionTool, ToolSet
from typing import Callable, Set, Any
import json
from dotenv import load_dotenv
load_dotenv()

CORA_PROMPT_TARGET = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))), 'prompts', 'ShopperAgentPrompt.txt')
with open(CORA_PROMPT_TARGET, 'r', encoding='utf-8') as file:
    CORA_PROMPT = file.read()

project_endpoint = os.environ["AZURE_AI_AGENT_ENDPOINT"]

project_client = AIProjectClient(
    endpoint=project_endpoint,
    credential=DefaultAzureCredential(),
)


with project_client:
    agent = project_client.agents.create_agent(
        model=os.environ["AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME"],  # Model deployment name
        name="Cora",  # Name of the agent
        instructions=CORA_PROMPT,  # Instructions for the agent
        # toolset=toolset
    )
    print(f"Created agent, ID: {agent.id}")
```

</details>

### 03: Create agents in Azure AI Foundry

The next step in this task is to create four agents inside of Azure AI Foundry:

1. **Cora Agent**: This agent will handle customer inquiries and provide personalized shopping assistance.
1. **Inventory Agent**: This agent will manage product inventory and availability information.
1. **Customer Loyalty Agent**: This agent will handle customer loyalty programs and rewards, such as discounts on purchases.
1. **Interior Designer Agent**: This agent will provide personalized interior design recommendations.

The prompts for these agents are available in `src/prompts/`. The code to deploy the agents is in `src/app/agents`.

<details markdown="block">
<summary><strong>Expand this section to view the solution</strong></summary>

First, navigate to [Azure AI Foundry](https://ai.azure.com) and select the AI project associated with this training.

Then, select the **Agents** tab from the left-hand menu.

Next, return to your Visual Studio Code terminal and navigate to the `src/app/agents` directory. Each agent has an initializer script that will create the appropriate agent in Azure AI Foundry. Run the following commands to create each of the four agents.

```bash
python customerLoyaltyAgent_initializer.py
python inventoryAgent_initializer.py
python interiorDesignAgent_initializer.py
python shopperAgent_initializer.py
```

As you create each agent, the script will output an Agent ID. Make a note of these IDs. There is a place in the .env file for each. Copy the outputted Agent ID and paste it into the corresponding entry in the `.env` file, specifically in the "Agent IDs" section. An example of an Agent ID is `asst_xxxxxxxxxxxxxxxxxxxxxxxxxxxx`. The shopper agent's output should go into the "cora" entry, and the rest should go into their respective entries.

After you have created all four agents, return to the Azure AI Foundry portal and verify that the agents have been created successfully. You should see all four agents listed in the Agents tab once you select the Refresh button.

</details>

### 04: Test the Cora agent

Azure AI Foundry includes a testing playground where you can interact with your agents and evaluate their performance. Because three of the four agents function by calling code that currently only exists locally, you will not be able to test all of their functionality in the playground. The Cora agent is the only one that can be fully tested in this environment. Write sample queries for the Cora agent to test its capabilities.

<details markdown="block">
<summary><strong>Expand this section to view the solution</strong></summary>

To access the playground, select the Cora agent from the list. Then, select the **Try in playground** button on the right-hand side. In the playground, you will be able to chat with the Cora agent. Use the following prompts to get an idea of how the Cora agent behaves.

- "What are the latest trends in home decor?"
- "Can you help me find a sofa that fits my style?"
- "Do you have any blue paint in stock?"
- "What is the availability of the 'Modern Chair'?"
- "I am ready to check out."

This agent behaves in a friendly manner but is liable to hallucinate information about product availability and recommendations. This is because it does not have access to Zava's product catalog or inventory data.

</details>

### 05: Update the chat application

Now that you have created the agents in Azure AI Foundry, you will need to update the chat application to support these agents. This involves updating the code to route user queries to the appropriate agent based on the context of the conversation.

To do so, uncomment the relevant sections of code in `chat_app.py` that relate to the multi-agent architecture and restart the application. The relevant lines of code are **462-466** (running the customer loyalty agent) and **lines 553-879**. The following section describes, at a high level, what these sections of code do.

<details markdown="block">
<summary><strong>Expand this section to view solution</strong></summary>

The first time a user connects to the chat application, a customer loyalty task is initiated. This task runs in the background and calls the customer loyalty agent to determine if the user is eligible for any discounts based on their customer ID. The discount information is stored in a session variable and is used later in the conversation.

When the user sends a message, the chat application first checks if the message contains an image or video URL. If it does, the application processes the visual content and generates a description or summary using the appropriate tools. This information is then included in the conversation history.

Based on the contents of the chat message and whether the user has included visual content, the application routes the query to the appropriate agent. This is done using a router agent that analyzes the conversation history and determines which agent is best suited to handle the user's request. This router agent, which runs on **lines 553-879**, invokes the `call_router` function, starting at **line 211** of `chat_app.py`. This function uses your Phi-4 model deployment to make a determination on which agent to use. The function also requires a prompt, which is located in `src/prompts/routerPrompt.txt`. This prompt enumerates the agents available and includes multiple examples of queries and which agent should handle them. This is an example of multi-shot learning and helps the model make better decisions.

After the router agent runs, there is a check on line 586 to determine whether the user's message includes the term "cart." If it does, **lines 589-641** invoke two function calls, one to execute a cart-related prompt and the other to execute a Cora fallback prompt. These two prompts are located in `src/prompts/addToCartPrompt.txt` and `src/prompts/CoraPrompt.txt`, respectively. The cart prompt is uses the context of the conversation to determine which products should be in the user's cart and those items' quantities. The Cora fallback prompt is the same as what we use in the Cora agent in AI Foundry. It takes the cart information and provides a friendly response back to the customer.

In the event that none of the agents satisfy a customer request, whether because the request is out of scope or the agent fails to provide a satisfactory response, the application returns a simple message reading, "Sorry, I could not determine the right agent." This is handled on **lines 648-659**.

Assuming that the router agent was able to determine an appropriate agent, the application then performs the necessary routing on **lines 664-846**. Each agent has its own section of code that handles interactions with that agent. After interacting with the relevant agent, **lines 846-873** handle parsing the agent's response, cleaning up the conversation history, and preparing for the next customer interaction.

</details>

### 06: Demonstrate application behavior

Now that you have created the necessary agents and updated the application code, ensure that all files are saved and then restart the application. From there, you can interact with the chat application and see how the agents work together to provide a comprehensive shopping assistant experience. Use the following prompts to test the application's behavior.

<details markdown="block">
<summary><strong>Expand this section to view solution</strong></summary>

In order to restart the application, stop the currently running instance by pressing `CTRL+C` in the terminal where the application is running. Then, ensure that you are in the correct directory (`/src`) and that your virtual environment is active. Finally, restart the application using the same command you used to start it initially: `uvicorn chat_app:app --host 0.0.0.0 --port 8000`.

Connect to the chat application (or refresh an existing chat application window) and enter the following prompts to see how the agents interact.

1. "I am thinking of painting my living room. Are you able to provide recommendations on this?"
2. "Of course! My room is approximately 25 feet by 18 feet in size."
3. "Those all sound great. Please add them to my cart." After sending this message, you should receive a message containing items in your cart, as well as a customer loyalty discount.
4. "I think I'd like Vanilla Dream for the wall color. Please add that to my cart as well."
5. "How many gallons of Vanilla Dream, PROD0011, do you have in stock?"
6. "I'd like to check out now."

Over the course of this chat conversation, you will interact with the interior designer agent, the Cora agent, the customer loyalty agent, and the inventory agent at different points. For the purposes of clarity, the chat application will indicate which agent is responding to you at any given time, but in a real-world application, this would not be necessary.

{: .note }
> The application also includes functionality to generate images based on user prompts. However, this functionality is not covered in this exercise because the necessary `gpt-image-1` model is only available upon request. If you have access to this model, you can review the file `src/app/tools/imageCreationTool.py` to understand how the image generation works. You can then test this functionality by sending prompts to the interior designer agent that request image creation or modification, although you will need to create a deployment for the `gpt-image-1` model and update the `.env` file accordingly.

</details>
